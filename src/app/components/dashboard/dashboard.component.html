<div class="dashboard-wrapper">
  <!-- Sidebar -->
  <nav class="sidebar" [class.collapsed]="isSidebarCollapsed">
    <div class="sidebar-header">
      <div class="d-flex align-items-center">
        <i class="bi bi-speedometer2 me-2"></i>
        <span class="sidebar-brand" *ngIf="!isSidebarCollapsed">Lambda Web</span>
      </div>
      <button class="btn btn-link text-white p-0 ms-auto" (click)="toggleSidebar()">
        <i class="bi" [class.bi-list]="isSidebarCollapsed" [class.bi-x-lg]="!isSidebarCollapsed"></i>
      </button>
    </div>

    <div class="sidebar-menu">
      <ul class="nav flex-column">
        <li class="nav-item">
          <a class="nav-link active" href="#">
            <i class="bi bi-people me-2"></i>
            <span *ngIf="!isSidebarCollapsed">Usuarios</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">
            <i class="bi bi-graph-up me-2"></i>
            <span *ngIf="!isSidebarCollapsed">Reportes</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">
            <i class="bi bi-gear me-2"></i>
            <span *ngIf="!isSidebarCollapsed">Configuración</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">
            <i class="bi bi-question-circle me-2"></i>
            <span *ngIf="!isSidebarCollapsed">Ayuda</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="sidebar-footer">
      <div class="user-info" *ngIf="currentUser">
        <div class="d-flex align-items-center p-3">
          <img [src]="'https://via.placeholder.com/40x40.png?text=' + (currentUser.USR_Name.charAt(0) || 'U')" 
               class="rounded-circle me-2" 
               width="40" 
               height="40"
               [alt]="currentUser.USR_Name + ' ' + currentUser.USR_LastName">
          <div *ngIf="!isSidebarCollapsed" class="flex-grow-1">
            <div class="text-white small">{{ currentUser.USR_Name }} {{ currentUser.USR_LastName }}</div>
            <div class="text-white-50 small">{{ currentUser.USR_UserRole }}</div>
          </div>
        </div>
        <div class="logout-btn">
          <button class="btn btn-outline-light btn-sm w-100" (click)="logout()">
            <i class="bi bi-box-arrow-right me-1"></i>
            <span *ngIf="!isSidebarCollapsed">Cerrar Sesión</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content" [class.sidebar-collapsed]="isSidebarCollapsed">
    <!-- Header -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col">
            <h1 class="h3 mb-0">Gestión de Usuarios</h1>
            <p class="text-muted mb-0">Administra todos los usuarios del sistema</p>
          </div>
          <div class="col-auto">
            <button class="btn btn-primary" (click)="openCreateUserModal()">
              <i class="bi bi-plus-lg me-1"></i>
              Nuevo Usuario
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="container-fluid">
      <div class="row mb-4">
        <div class="col-md-3 mb-3">
          <div class="card stats-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title text-muted">Total Usuarios</h6>
                  <h3 class="mb-0">{{ userStats.total }}</h3>
                </div>
                <div class="stats-icon bg-primary">
                  <i class="bi bi-people"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 mb-3">
          <div class="card stats-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title text-muted">Usuarios Activos</h6>
                  <h3 class="mb-0 text-success">{{ userStats.active }}</h3>
                </div>
                <div class="stats-icon bg-success">
                  <i class="bi bi-check-circle"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 mb-3">
          <div class="card stats-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title text-muted">Usuarios Inactivos</h6>
                  <h3 class="mb-0 text-warning">{{ userStats.inactive }}</h3>
                </div>
                <div class="stats-icon bg-warning">
                  <i class="bi bi-pause-circle"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 mb-3">
          <div class="card stats-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title text-muted">Entrenadores</h6>
                  <h3 class="mb-0 text-warning">{{ userStats.byRole.trainer }}</h3>
                </div>
                <div class="stats-icon bg-warning">
                  <i class="bi bi-person-check"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters and Search -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Buscar usuario</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="bi bi-search"></i>
                </span>
                <input type="text" 
                       class="form-control" 
                       placeholder="Nombre o email..."
                       [(ngModel)]="searchTerm"
                       (input)="onSearchChange()">
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Filtrar por rol</label>
              <select class="form-select" 
                      [(ngModel)]="selectedRole"
                      (change)="onFilterChange()">
                <option value="">Todos los roles</option>
                <option value="admin">Administrador</option>
                <option value="trainer">Entrenador</option>
                <option value="trainee">Aprendiz</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Filtrar por estado</label>
              <select class="form-select" 
                      [(ngModel)]="selectedStatus"
                      (change)="onFilterChange()">
                <option value="">Todos los estados</option>
                <option value="active">Activo</option>
                <option value="inactive">Inactivo</option>
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button class="btn btn-outline-secondary w-100" 
                      (click)="searchTerm = ''; selectedRole = ''; selectedStatus = ''; onFilterChange()">
                <i class="bi bi-arrow-clockwise me-1"></i>
                Limpiar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Table -->
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-table me-2"></i>
            Lista de Usuarios ({{ filteredUsers.length }})
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Usuario</th>
                  <th>Email</th>
                  <th>Rol</th>
                  <th>Departamento</th>
                  <th>Teléfono</th>
                  <th>Estado</th>
                  <th>Fecha Registro</th>
                  <th width="120">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="isLoading">
                  <td colspan="8" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Cargando...</span>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="!isLoading && filteredUsers.length === 0">
                  <td colspan="8" class="text-center py-4 text-muted">
                    <i class="bi bi-inbox display-6 d-block mb-2"></i>
                    No se encontraron usuarios
                  </td>
                </tr>
                <tr *ngFor="let user of filteredUsers">
                  <td>
                    <div class="d-flex align-items-center">
                      <img [src]="user.avatar || 'https://via.placeholder.com/32x32.png?text=' + user.name.charAt(0)" 
                           class="rounded-circle me-2" 
                           width="32" 
                           height="32"
                           [alt]="user.name">
                      <strong>{{ user.name }}</strong>
                    </div>
                  </td>
                  <td>{{ user.email }}</td>
                  <td>
                    <span class="badge" [class]="getRoleBadgeClass(user.role)">
                      {{ user.role }}
                    </span>
                  </td>
                  <td>{{ user.department || '-' }}</td>
                  <td>{{ user.phone || '-' }}</td>
                  <td>
                    <div class="form-check form-switch">
                      <input class="form-check-input" 
                             type="checkbox" 
                             [checked]="user.isActive"
                             (change)="toggleUserStatus(user)">
                      <label class="form-check-label">
                        {{ user.isActive ? 'Activo' : 'Inactivo' }}
                      </label>
                    </div>
                  </td>
                  <td>{{ user.createdAt | date:'short' }}</td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-primary" 
                              (click)="openEditUserModal(user)"
                              title="Editar">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-outline-danger" 
                              (click)="deleteUser(user)"
                              title="Eliminar">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Modal para Crear/Editar Usuario -->
<div class="modal fade" [class.show]="showUserModal" [style.display]="showUserModal ? 'block' : 'none'" 
     *ngIf="showUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi" [class.bi-plus-lg]="!editingUser" [class.bi-pencil]="editingUser" class="me-2"></i>
          {{ editingUser ? 'Editar Usuario' : 'Nuevo Usuario' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeUserModal()"></button>
      </div>
      <div class="modal-body">
        <form #userFormRef="ngForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Nombre *</label>
              <input type="text" 
                     class="form-control" 
                     [(ngModel)]="userForm.firstName"
                     name="firstName"
                     required
                     placeholder="Ej: Juan">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Apellido *</label>
              <input type="text" 
                     class="form-control" 
                     [(ngModel)]="userForm.lastName"
                     name="lastName"
                     required
                     placeholder="Ej: Pérez">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Email *</label>
              <input type="email" 
                     class="form-control" 
                     [(ngModel)]="userForm.email"
                     name="email"
                     required
                     placeholder="ejemplo@correo.com">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Teléfono *</label>
              <input type="tel" 
                     class="form-control" 
                     [(ngModel)]="userForm.phone"
                     name="phone"
                     required
                     maxlength="10"
                     placeholder="1234567890">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Contraseña *</label>
              <input type="password" 
                     class="form-control" 
                     [(ngModel)]="userForm.password"
                     name="password"
                     [required]="!editingUser"
                     minlength="8"
                     placeholder="Mínimo 8 caracteres">
              <small class="form-text text-muted" *ngIf="!editingUser">
                Mínimo 8 caracteres
              </small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Rol *</label>
              <select class="form-select" 
                      [(ngModel)]="userForm.role"
                      name="role"
                      required>
                <option value="trainee">Aprendiz</option>
                <option value="trainer">Entrenador</option>
              </select>
              <small class="form-text text-muted">
                Solo puede crear Entrenadores y Aprendices
              </small>
            </div>
          </div>
          <div class="row" *ngIf="editingUser">
            <div class="col-md-6 mb-3">
              <label class="form-label">Departamento</label>
              <input type="text" 
                     class="form-control" 
                     [(ngModel)]="userForm.department"
                     name="department">
            </div>
            <div class="col-md-6 mb-3 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" 
                       type="checkbox" 
                       [(ngModel)]="userForm.isActive"
                       name="isActive"
                       id="isActive">
                <label class="form-check-label" for="isActive">
                  Usuario activo
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeUserModal()">
          Cancelar
        </button>
        <button type="button" 
                class="btn btn-primary" 
                (click)="saveUser()"
                [disabled]="!editingUser && (!userForm.firstName || !userForm.lastName || !userForm.email || !userForm.phone || !userForm.password || userForm.password.length < 8)">
          <i class="bi bi-save me-1"></i>
          {{ editingUser ? 'Actualizar' : 'Crear' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showUserModal"></div>